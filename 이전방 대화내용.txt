현재 기본 세션: PowerShell 7 (Core, 7.5.2)
PS C:\giwanos> $ErrorActionPreference='Stop'
>> $ROOT = "C:\giwanos"
>>
>> # 5.1 러너가 떠있으면 강제 종료
>> Get-Process -ErrorAction SilentlyContinue |
>>   ? { $_.Name -match 'powershell' -and $_.Path -like '*\WindowsPowerShell\v1.0\powershell.exe' } |
>>   Stop-Process -Force -ErrorAction SilentlyContinue
>>
>> # 시작 프로그램 Run 키를 pwsh(7)로 갱신
>> $pwsh = (Get-Command pwsh).Source
>> $cmd  = "`"$pwsh`" -NoLogo -NoProfile -ExecutionPolicy Bypass -File `"$ROOT\scripts\autosave_runner.ps1`""
>> New-Item -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "VELOS_AutoSaveRunner" -Force | Out-Null
>> Set-ItemProperty "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "VELOS_AutoSaveRunner" -Value $cmd
>>
>> # 새 러너 즉시 기동 (pwsh7)
>> Start-Process $pwsh -ArgumentList '-NoLogo -NoProfile -ExecutionPolicy Bypass -File "C:\giwanos\scripts\autosave_runner.ps1"'
>>
PS C:\giwanos> $code = @'
>> [CmdletBinding()] param([int]$DebounceMs=1500)
>> $ErrorActionPreference="Stop"
>> $ROOT = "C:\giwanos"
>> $LOCK = Join-Path $ROOT "data\logs\run.lock"
>> $LOG  = Join-Path $ROOT ("data\logs\autosave_runner_{0}.log" -f (Get-Date -Format yyyyMMdd))
>> $script:lastRun = 0
>>
>> function Log($m){ "[{0}] {1}" -f (Get-Date -Format "HH:mm:ss"),$m | Out-File -FilePath $LOG -Append -Encoding UTF8 }
>>
>> function KickRun([string]$reason,[string]$path){
>>   $now=[Environment]::TickCount64
>>   if ($now - $script:lastRun -lt $DebounceMs){ return }
>>   if (Test-Path $LOCK){ Log "skip(lock): $reason :: $path"; return }
>>   try {
>>     New-Item -ItemType File -Path $LOCK -Force | Out-Null
>>     Log "preflight... ($reason :: $path)"
>>     pwsh -NoLogo -NoProfile -ExecutionPolicy Bypass -File "C:\giwanos\scripts\preflight_quickcheck.ps1" 2>$null
>>     if ($LASTEXITCODE -ne 0){ Log "preflight FAIL ($reason)"; return }
>>     Log "run start"
>>     pwsh -NoLogo -NoProfile -ExecutionPolicy Bypass -File "C:\giwanos\scripts\velos-run-all.ps1" -NoOpen
>>     Log "run done"
>>   } catch {
>>     Log ("ERROR: {0}" -f $_.Exception.Message)
>>   } finally {
>>     Remove-Item $LOCK -Force -ErrorAction SilentlyContinue
>>     $script:lastRun = [Environment]::TickCount64
>>   }
>> }
>>
>> # ===== Watcher =====
>> $watchRoots = @("$ROOT")
>> $filters    = @("*.py","*.ps1","*.json")
>>
>> foreach($wr in $watchRoots){
>>   $fsw = New-Object IO.FileSystemWatcher $wr, "*.*"
>>   $fsw.IncludeSubdirectories = $true
>>   $fsw.EnableRaisingEvents  = $true
>>   $fsw.NotifyFilter = [IO.NotifyFilters]'FileName, LastWrite, Size'
>>
>>   Register-ObjectEvent $fsw Changed -Action {
>>     $p=$EventArgs.FullPath; if($filters -notcontains ("*"+[IO.Path]::GetExtension($p))){return}
>>     Log "event: Changed :: $p";  KickRun "Changed" $p
>>   } | Out-Null
>>   Register-ObjectEvent $fsw Created -Action {
>>     $p=$EventArgs.FullPath; if($filters -notcontains ("*"+[IO.Path]::GetExtension($p))){return}
>>     Log "event: Created :: $p";  KickRun "Created" $p
>>   } | Out-Null
>>   Register-ObjectEvent $fsw Renamed -Action {
>>     $p=$EventArgs.FullPath; if($filters -notcontains ("*"+[IO.Path]::GetExtension($p))){return}
>>     Log "event: Renamed :: $p";  KickRun "Renamed" $p
>>   } | Out-Null
>> }
>>
>> "[{0}] watch start" -f (Get-Date -Format "yyyy-MM-dd HH:mm:ss") | Out-File -FilePath $LOG -Append -Encoding UTF8
>> while($true){ Start-Sleep -Milliseconds 400 }
>> '@
>> [IO.File]::WriteAllText("C:\giwanos\scripts\autosave_runner.ps1",$code,[Text.UTF8Encoding]::new($false))
>>
PS C:\giwanos> # 3-1. 더미 저장으로 이벤트 발생
>> "d=1" | Out-File "C:\giwanos\modules\_autosave_ping__.py" -Encoding UTF8
>>
>> # 3-2. 로그/최신 리포트 확인
>> Get-Content "C:\giwanos\data\logs\autosave_runner_$(Get-Date -Format yyyyMMdd).log" -Tail 60
>> Get-ChildItem "C:\giwanos\data\reports\auto\*.md" | Sort-Object LastWriteTime -Desc | Select -First 1 Name,LastWriteTime
>>
[2025-08-14 23:06:35] watch start
[2025-08-14 23:29:48] watch start
[2025-08-14 23:35:07] watch start
[2025-08-14 23:46:47] watch start

Name                                 LastWriteTime
----                                 -------------
velos_auto_report_20250814_123826.md 2025-08-14 오후 9:38:26

PS C:\giwanos>
