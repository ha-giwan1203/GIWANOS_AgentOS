# run_giwanos_master_loop.py

## 개요

VELOS 시스템의 메인 루프를 담당하는 핵심 스크립트입니다. 시스템 상태를 모니터링하고, 자동 보고서를 생성하며, 외부 서비스로 전송할 디스패치 티켓을 생성합니다.

**위치**: `scripts/run_giwanos_master_loop.py`

## 주요 기능

1. **자동 보고서 생성**: 시스템 상태를 요약한 마크다운 보고서 생성
2. **디스패치 티켓 생성**: 외부 서비스(Slack, Notion)로 전송할 티켓 생성
3. **시스템 상태 모니터링**: 기본적인 시스템 상태 확인
4. **메모리 관리**: 학습 메모리 업데이트 및 동기화

## 코드 구조

### 주요 변수
```python
REPORT_DIR = os.path.join(ROOT, "data", "reports", "auto")
DISPATCH_DIR = os.path.join(ROOT, "data", "reports", "_dispatch")
ts = datetime.datetime.utcnow().strftime("%Y%m%d_%H%M%S")
```

### 보고서 생성 로직
```python
body = [
  f"# VELOS Auto Report ({ts} UTC)",
  "",
  "- System: OK",
  "- Logs: summarized", 
  "- Memory: updated",
  "",
  "_This file was generated by run_giwanos_master_loop.py_",
]
```

### 디스패치 티켓 구조
```python
ticket = {
  "id": str(uuid.uuid4()),
  "created_utc": ts,
  "artifacts": [
    {"type": "markdown", "path": str(report_md), "title": f"VELOS Report {ts}"}
  ],
  "send": {
    "slack": True,
    "notion": True,
    "push": False,
    "email": False
  },
  "meta": {"source": "master", "note": "auto generated"}
}
```

## 실행 방법

### 기본 실행
```bash
python scripts/run_giwanos_master_loop.py
```

### 스케줄링 실행 (Windows)
```powershell
schtasks /create /tn "VELOS_Master_Loop" /tr "python C:\giwanos\scripts\run_giwanos_master_loop.py" /sc daily /st 09:00
```

### 스케줄링 실행 (Linux/macOS)
```bash
# crontab에 추가
0 9 * * * cd /path/to/giwanos && python scripts/run_giwanos_master_loop.py
```

## 출력 파일

### 생성되는 파일들
1. **보고서 파일**: `data/reports/auto/velos_auto_report_YYYYMMDD_HHMMSS.md`
2. **디스패치 티켓**: `data/reports/_dispatch/dispatch_YYYYMMDD_HHMMSS.json`

### 파일 내용 예시
```markdown
# VELOS Auto Report (20250814_064536 UTC)

- System: OK
- Logs: summarized
- Memory: updated

_This file was generated by run_giwanos_master_loop.py_
```

## 의존성

### 필수 모듈
- `modules.report_paths`: 경로 관리
- `os`, `sys`, `json`, `datetime`, `uuid`: 표준 라이브러리

### 환경변수
- `VELOS_ROOT`: VELOS 루트 디렉토리 (기본값: `C:\giwanos`)

## 오류 처리

### 일반적인 오류
1. **경로 오류**: 디렉토리가 존재하지 않는 경우 자동 생성
2. **권한 오류**: 파일 쓰기 권한 확인 필요
3. **메모리 오류**: 시스템 리소스 부족 시 로그 기록

### 오류 로깅
```python
# 오류 발생 시 로그 파일에 기록
with open(log_file, "a", encoding="utf-8") as f:
    f.write(f"[ERROR] {timestamp}: {error_message}\n")
```

## 성능 고려사항

### 최적화 포인트
1. **파일 I/O**: 비동기 처리 고려
2. **메모리 사용량**: 대용량 데이터 처리 시 배치 처리
3. **실행 시간**: 스케줄링 간격 조정 가능

### 모니터링
```bash
# 실행 시간 측정
time python scripts/run_giwanos_master_loop.py

# 메모리 사용량 확인
python -c "import psutil; print(psutil.Process().memory_info().rss / 1024 / 1024, 'MB')"
```

## 확장 가능성

### 향후 개선 사항
1. **실제 데이터 수집**: 현재 샘플 데이터를 실제 시스템 데이터로 교체
2. **고급 분석**: 시스템 성능 지표 추가
3. **알림 시스템**: 오류 발생 시 즉시 알림
4. **설정 외부화**: 보고서 형식과 전송 설정을 설정 파일로 관리

### 플러그인 구조
```python
# 향후 플러그인 시스템 도입 가능
plugins = load_plugins()
for plugin in plugins:
    plugin.process(report_data)
```

## 테스트

### 단위 테스트
```python
def test_report_generation():
    # 보고서 생성 테스트
    pass

def test_dispatch_ticket_creation():
    # 디스패치 티켓 생성 테스트
    pass
```

### 통합 테스트
```python
def test_full_workflow():
    # 전체 워크플로우 테스트
    pass
```

## 주의사항

1. **파일명 고정**: 생성되는 파일명 형식 변경 금지
2. **경로 의존성**: `modules.report_paths` 모듈에 의존
3. **타임스탬프**: UTC 시간 기준으로 생성
4. **UUID 생성**: 고유 식별자로 UUID 사용

## 관련 파일

- `scripts/velos_bridge.py`: 디스패치 티켓 처리
- `modules/report_paths.py`: 경로 관리
- `data/reports/auto/`: 자동 생성 보고서 저장소
- `data/reports/_dispatch/`: 디스패치 대기열

---

**문서 버전**: 1.0  
**최종 업데이트**: 2025-08-14  
**작성자**: VELOS Development Team
