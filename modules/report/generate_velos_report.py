# [ACTIVE] VELOS ìš´ì˜ ì² í•™ ì„ ì–¸ë¬¸
# =========================================================
# 1) íŒŒì¼ëª… ê³ ì •: ì‹œìŠ¤í…œ íŒŒì¼ëª…Â·ê²½ë¡œÂ·êµ¬ì¡°ëŠ” ê³ ì •, ì„ì˜ ë³€ê²½ ê¸ˆì§€
# 2) ìê°€ ê²€ì¦ í•„ìˆ˜: ìˆ˜ì •/ë°°í¬ ì „ ìë™Â·ìˆ˜ë™ í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í•´ì•¼ í•¨
# 3) ì‹¤í–‰ ê²°ê³¼ ì§ì ‘ í…ŒìŠ¤íŠ¸: ì½”ë“œ ì œê³µ ì‹œ ì‹¤í–‰ ê²°ê³¼ë¥¼ ë™ë´‰/ê¸°ë¡
# 4) ì €ì¥ ê²½ë¡œ ê³ ì •: ROOT=C:/giwanos ê¸°ì¤€, ìš°íšŒ/ì¶”ì¸¡ ê²½ë¡œ ê¸ˆì§€
# 5) ì‹¤íŒ¨ ê¸°ë¡Â·íšŒê³ : ì‹¤íŒ¨ ë¡œê·¸ë¥¼ ë‚¨ê¸°ê³  í›„ì† ì»¤ë°‹/ë¬¸ì„œì— ë°˜ì˜
# 6) ê¸°ì–µ ë°˜ì˜: ì‘ì—…/ëŒ€í™” ë§¥ë½ì„ ë©”ëª¨ë¦¬ì— ì €ì¥í•˜ê³  ë¡œë”©ì— ì‚¬ìš©
# 7) êµ¬ì¡° ê¸°ë°˜ íŒë‹¨: í”„ë¡œì íŠ¸ êµ¬ì¡° ê¸°ì¤€ìœ¼ë¡œë§Œ íŒë‹¨ (ì¶”ì¸¡ ê¸ˆì§€)
# 8) ì¤‘ë³µ/ì˜¤ë¥˜ ì œê±°: ë¶ˆí•„ìš”/ì¤‘ë³µ ë¡œì§ ì œê±°, ë‹¨ì¼ ì§„ì‹¤ì›ì¹™ ìœ ì§€
# 9) ì§€ëŠ¥í˜• ì²˜ë¦¬: ìë™ ë³µêµ¬Â·ê²½ê³  ë“± ë°©ì–´ì  ì„¤ê³„ ìš°ì„ 
# 10) ê±°ì§“ ì½”ë“œ ì ˆëŒ€ ë¶ˆê°€: ì‹¤í–‰ ë¶ˆê°€Â·ë¯¸ê²€ì¦Â·í—ˆìœ„ ì¶œë ¥ ì¼ì²´ ê¸ˆì§€
# =========================================================
import os
import sys
import json
import time
import sqlite3
from datetime import datetime, timedelta
from typing import Dict, Any, List

ROOT = os.getenv("VELOS_ROOT", "/workspace")
if ROOT not in sys.path:
    sys.path.append(ROOT)

def get_system_stats() -> Dict[str, Any]:
    """ì‹œìŠ¤í…œ í†µê³„ ìˆ˜ì§‘"""
    try:
        # ë©”ëª¨ë¦¬ í†µê³„
        memory_stats = {"error": "memory_adapter_not_available"}
        try:
            from modules.core.memory_adapter import MemoryAdapter
            adapter = MemoryAdapter()
            memory_stats = adapter.get_stats()
        except Exception as e:
            memory_stats = {"error": str(e)}

        # í—¬ìŠ¤ ë¡œê·¸ ì½ê¸°
        health_log = {}
        health_path = os.path.join(ROOT, "data", "logs", "system_health.json")
        if os.path.exists(health_path):
            try:
                with open(health_path, "r", encoding="utf-8") as f:
                    health_log = json.load(f)
            except Exception as e:
                health_log = {"error": str(e)}

        # ìµœê·¼ ìŠ¤ëƒ…ìƒ· í™•ì¸
        snapshots = []
        snapshots_dir = os.path.join(ROOT, "data", "snapshots")
        if os.path.exists(snapshots_dir):
            try:
                for item in os.listdir(snapshots_dir):
                    if item.startswith("snapshot_"):
                        snapshots.append(item)
                snapshots.sort(reverse=True)
            except Exception as e:
                snapshots = [f"error: {e}"]

        return {
            "memory_stats": memory_stats,
            "health_log": health_log,
            "recent_snapshots": snapshots[:5],  # ìµœê·¼ 5ê°œë§Œ
            "timestamp": datetime.now().isoformat()
        }
    except Exception as e:
        return {"error": str(e)}

def generate_markdown_report(stats: Dict[str, Any]) -> str:
    """Markdown í˜•ì‹ ë³´ê³ ì„œ ìƒì„±"""
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    report_lines = [
        f"# VELOS System Report - {timestamp}",
        "",
        "## ğŸ“Š System Statistics",
        ""
    ]

    # ë©”ëª¨ë¦¬ í†µê³„
    if "memory_stats" in stats:
        mem_stats = stats["memory_stats"]
        if "error" not in mem_stats:
            report_lines.extend([
                "### Memory Status",
                f"- Buffer Size: {mem_stats.get('buffer_size', 'N/A')}",
                f"- DB Records: {mem_stats.get('db_records', 'N/A')}",
                f"- JSON Records: {mem_stats.get('json_records', 'N/A')}",
                ""
            ])
        else:
            report_lines.extend([
                "### Memory Status",
                f"- Error: {mem_stats['error']}",
                ""
            ])

    # í—¬ìŠ¤ ë¡œê·¸
    if "health_log" in stats:
        health = stats["health_log"]
        if "error" not in health:
            report_lines.extend([
                "### Health Status",
                f"- System Integrity: {health.get('system_integrity_ok', 'Unknown')}",
                f"- Data Integrity: {health.get('data_integrity_ok', 'Unknown')}",
                ""
            ])
        else:
            report_lines.extend([
                "### Health Status",
                f"- Error: {health['error']}",
                ""
            ])

    # ìŠ¤ëƒ…ìƒ· ì •ë³´
    if "recent_snapshots" in stats:
        snapshots = stats["recent_snapshots"]
        report_lines.extend([
            "### Recent Snapshots",
        ])
        if snapshots:
            for snapshot in snapshots:
                report_lines.append(f"- {snapshot}")
        else:
            report_lines.append("- No snapshots found")
        report_lines.append("")

    # ìƒì„± ì •ë³´
    report_lines.extend([
        "---",
        f"*Generated by VELOS Report Generator at {timestamp}*",
        "*Based on VELOS Operating Philosophy*"
    ])

    return "\n".join(report_lines)

def save_report(report_content: str) -> Dict[str, Any]:
    """ë³´ê³ ì„œ ì €ì¥"""
    try:
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        report_filename = f"velos_report_{timestamp}.md"
        report_path = os.path.join(ROOT, "data", "reports", report_filename)

        # ë””ë ‰í† ë¦¬ ìƒì„±
        os.makedirs(os.path.dirname(report_path), exist_ok=True)

        # íŒŒì¼ ì €ì¥
        with open(report_path, "w", encoding="utf-8") as f:
            f.write(report_content)

        return {
            "success": True,
            "report_path": report_path,
            "filename": report_filename
        }
    except Exception as e:
        return {
            "success": False,
            "error": str(e)
        }

def main():
    print("=== VELOS Report Generator ===")

    # ì‹œìŠ¤í…œ í†µê³„ ìˆ˜ì§‘
    print("ğŸ“Š Collecting system statistics...")
    stats = get_system_stats()

    # ë³´ê³ ì„œ ìƒì„±
    print("ğŸ“ Generating report...")
    report_content = generate_markdown_report(stats)

    # ë³´ê³ ì„œ ì €ì¥
    print("ğŸ’¾ Saving report...")
    save_result = save_report(report_content)

    if save_result["success"]:
        print(f"âœ… Report generated successfully")
        print(f"ğŸ“ Location: {save_result['report_path']}")
        print(f"ğŸ“„ Filename: {save_result['filename']}")

        # ê²°ê³¼ë¥¼ JSONìœ¼ë¡œ ì¶œë ¥
        result = {
            "success": True,
            "report_path": save_result["report_path"],
            "filename": save_result["filename"],
            "stats": stats
        }
        print(json.dumps(result, ensure_ascii=False, indent=2))
        sys.exit(0)
    else:
        print(f"âŒ Report generation failed: {save_result['error']}")
        sys.exit(1)

if __name__ == "__main__":
    main()
